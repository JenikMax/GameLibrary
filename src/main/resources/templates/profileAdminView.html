<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/css/profile_admin.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}">
    <script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
    <script>

        $(document).ready(function () {
            document.getElementById("h_searchText").addEventListener("keyup", function(event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    document.getElementById("h_searchButton").click();
                }
            });
            document.getElementById('pass_form').addEventListener('submit', function(e) {
                e.preventDefault(); // Отменить переход на другую страницу

                var password = document.getElementById('password').value; // Пароль
                var passwordRepeate = document.getElementById('password_repeate').value; // Повторный пароль


                // Проверка пароля
                if (password.length < 6) {
                    document.getElementById('error').innerText = '[[#{view.user.pass.length.error.message}]]';
                    return; // Остановить выполнение кода
                }

                if (password !== passwordRepeate) {
                    document.getElementById('error').innerText = '[[#{view.user.pass.repeat.error.message}]]';
                    return; // Остановить выполнение кода
                }

                e.target.submit();
            });

        });

        function showPopup() {
            var message = document.getElementById("message").value;
            if (message) {
                var popup = document.getElementById("popup");
                popup.innerHTML = message + '<span class="popup-close" onclick="closePopup()">&times;</span>';
                popup.style.display = "block";
                setTimeout(function() {
                    closePopup();
                }, 5000);
            }
        }

        function closePopup() {
            var popup = document.getElementById("popup");
            popup.style.display = "none";
        }


        function previewImage(input) {
            var imagePreview = document.getElementById("imagePreview");
            imagePreview.innerHTML = "";

            var file = input.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var imgElement = document.createElement("img");
                    imgElement.src = e.target.result;

                    var removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.innerText = "[[#{view.navigation.delete.button}]]";
                    removeButton.onclick = function () {
                        imagePreview.innerHTML = "";
                        input.value = "";
                        logoInput.value = "";
                    };

                    imagePreview.appendChild(imgElement);
                    imagePreview.appendChild(removeButton);

                    // Обновляем значение поля logo при загрузке нового изображения
                    logoInput.value = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }


        function updateValue(checkbox) {
            checkbox.value = checkbox.checked ? 'true' : 'false';
        }
    </script>

</head>
<body onload="showPopup()">
<div id="popup" class="popup"></div>
<input type="hidden" id="message" th:value="${message}"/>
<div class="container">
    <div class="header">
        <div class="header_library">
            <a th:href="@{/library}" style="text-decoration: none; color: inherit;">
                <img th:src="@{/img/logo.jpg}" alt="Logo">
            </a>
        </div>
        <div class="header_search">
            <form th:action="@{/search}" method="post">
                <div class="search_container">
                    <input type="text" th:placeholder="#{view.library.filter.search.name.placeholder}" name="searchText" id="h_searchText" th:value="${searchText}"><button id="h_searchButton" type="submit" th:text="#{view.navigation.find}"></button>
                </div>
            </form>
        </div>
        <div class="header_user">
            <form th:action="@{/logout}" method="post">
                <div class="user_container">
                    <div class="avatar">
                        <a th:href="@{/profile}" style="text-decoration: none; color: inherit;" th:alt="${user.name}">
                            <img th:src="${user.avatar}"  th:alt="${user.name}"/>
                        </a>
                    </div>
                    <div class="logout_button">
                        <button type="submit" th:text="#{view.user.logout.button}"></button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="profile">
        <h1 th:text="#{view.profile.admin.title.short} + ' ' + ${user.name}"></h1>
        <form th:action="@{'/profile'}" method="post">
            <input type="hidden" name="id" th:value="${user.id}">
            <input type="hidden" name="name" th:value="${user.name}">
            <div class="avatar_ico">
                <div class="label-container">
                    <label for="avatar_attach" th:text="#{view.profile.picture}"></label>
                </div>
                <input type="file" id="avatar_attach" name="avatar_attach" accept="image/*" onchange="previewImage(this)">
                <div class="imagePreview-container">
                    <div id="imagePreview" class="imagePreview"></div>
                </div>
                <input type="hidden" id="avatar" name="avatar" th:value="${user.avatar}">
                <script>
                    var logoInput = document.getElementById("avatar");

                    // Проверяем, есть ли значение в поле logo при загрузке формы
                    if (logoInput.value) {
                        var imagePreview = document.getElementById("imagePreview");
                        var imgElement = document.createElement("img");
                        imgElement.src = logoInput.value;

                        var removeButton = document.createElement("button");
                        removeButton.type = "button";
                        removeButton.innerText = "[[#{view.navigation.delete.button}]]";
                        removeButton.onclick = function () {
                            imagePreview.innerHTML = "";
                            logoInput.value = "";
                        };

                        imagePreview.appendChild(imgElement);
                        imagePreview.appendChild(removeButton);
                    }
                </script>
            </div>
            <div class="s_button">
                <button type="submit" value="update" th:text="#{view.profile.update.button}"></button>
            </div>
        </form>
        <form id="pass_form" th:action="@{'/profile/pass'}" method="post">
            <input type="hidden" name="id" th:value="${user.id}">
            <input type="hidden" name="name" th:value="${user.name}">
            <div id="error" class="error"></div>
            <div class="user_pass">
                <div class="label-container">
                    <label for="password" th:text="#{view.profile.pass}"></label>
                </div>
                <input type="password" id="password" name="pass" th:placeholder="#{view.profile.pass.new}" required>
                <input type="password" id="password_repeate" name="pass_repeate" th:placeholder="#{view.profile.pass.new.repeat}" required >
            </div>
            <div class="s_button">
                <button type="submit" value="update" th:text="#{view.profile.update.pass.button}"></button>
            </div>
        </form>
    </div>
    <div class="users_list scrollable">
        <div class="user_profile" th:each="shortUser : ${users}">
            <form th:action="@{/profile/update}" method="post">
                <input type="hidden" name="id" th:value="${shortUser.id}">
                <div class="user_profile_name">
                    <span th:text="${shortUser.name}" />
                </div>
                <div class="user_profile_checkbox">
                    <ul>
                        <li><img th:src="${shortUser.avatar}"></li>
                    </ul>
                    <ul>
                        <li>
                            <label th:for="'isAdmin_' + ${shortUser.id}" th:text="#{view.profile.admin.isadmin}"></label>
                            <input type="checkbox" th:id="'isAdmin_' + ${shortUser.id}" name="isAdmin" th:value="${shortUser.isAdmin ? true : false}"
                                   th:checked="${shortUser.isAdmin ? 'true' : null}" onclick="updateValue(this)">
                        </li>
                        <li>
                            <label th:for="'isActive_' + ${shortUser.id}" th:text="#{view.profile.admin.isactive}"></label>
                            <input type="checkbox" th:id="'isActive_' + ${shortUser.id}" name="isActive" th:value="${shortUser.isActive ? true : false}"
                                   th:checked="${shortUser.isActive ? 'true' : null}" onclick="updateValue(this)">
                        </li>
                    </ul>
                </div>
                <div class="button_action">
                    <button type="submit" th:text="#{view.navigation.confirm}"></button>
                </div>
            </form>
            <form th:action="@{/profile/pass_reset}" method="post">
                <input type="hidden" name="id" th:value="${shortUser.id}">
                <div class="button_action">
                    <button type="submit" th:text="#{view.navigation.reset.pass}"></button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
