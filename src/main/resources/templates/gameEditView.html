<html>
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/css/game_edit.css}">
    <script>
        function goBack() {
            window.history.back();
        }

        function addGenre() {
            var selectedGenre = document.getElementById("genre");
            var genreList = document.getElementById("genreList");

            if (selectedGenre.value !== "" && !checkDuplicateGenre(selectedGenre.value)) {
                var genreDiv = document.createElement("div");
                genreDiv.innerHTML = "<span>" + selectedGenre.value + "</span>"
                    + "<button type='button' onclick='removeGenre(this)'>Удалить</button>";
                genreList.appendChild(genreDiv);

                var hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "genres";
                hiddenInput.value = selectedGenre.value;
                genreDiv.appendChild(hiddenInput);

                selectedGenre.selectedIndex = 0;
            } else {
                // Обработка ошибки выбора дубликата или невалидного жанра
            }
        }

        function removeGenre(element) {
            element.parentElement.remove();
        }

        function checkDuplicateGenre(genreValue) {
            var genreList = document.querySelectorAll("#genreList span");
            for (var i = 0; i < genreList.length; i++) {
                if (genreList[i].textContent === genreValue) {
                    return true;
                }
            }
            return false;
        }



        function previewImage(input) {
            var imagePreview = document.getElementById("imagePreview");
            imagePreview.innerHTML = "";

            var file = input.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var imgElement = document.createElement("img");
                    imgElement.src = e.target.result;

                    var removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.innerText = "Удалить";
                    removeButton.onclick = function () {
                        imagePreview.innerHTML = "";
                        input.value = "";
                        logoInput.value = "";
                    };

                    imagePreview.appendChild(imgElement);
                    imagePreview.appendChild(removeButton);

                    // Обновляем значение поля logo при загрузке нового изображения
                    logoInput.value = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }


        function previewScreenshots(input) {
            var screenshotList = document.getElementById("screenshotsList");

            var files = input.files;
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var reader = new FileReader();
                reader.onload = function (e) {
                    var screenshotDiv = document.createElement("div");
                    screenshotDiv.className = "screenshot-item";

                    var imgElement = document.createElement("img");
                    imgElement.src = e.target.result;

                    var removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.innerText = "Удалить";
                    removeButton.onclick = function () {
                        screenshotDiv.remove();
                    };

                    var hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "screenshots";
                    hiddenInput.value = e.target.result;

                    screenshotDiv.appendChild(imgElement);
                    screenshotDiv.appendChild(removeButton);
                    screenshotDiv.appendChild(hiddenInput);

                    screenshotList.appendChild(screenshotDiv);
                }
                reader.readAsDataURL(file);
            }
        }

        function removeScreenshot(button) {
            var screenshotDiv = button.parentElement;
            screenshotDiv.remove();
        }
    </script>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">
            <img src="logo.png" alt="Logo">
        </div>
        <div class="user">
            <img src="user.png" alt="User">
            <a href="profile.html">Иван Иванов</a>
            <button type="button">Выйти</button>
        </div>
    </div>
    <div class="data">
        <h2>Выбор источника данных</h2>
        <form action="get.html" method="get">
            <label for="source">Источник данных</label>
            <select id="source" name="source">
                <option value="manual">Ручной ввод</option>
                <option value="iddb">IDDB</option>
                <option value="playground">Playground.ru</option>
                <option value="igromania">Igromania.ru</option>
                <option value="stopgame">Stopgame.ru</option>
            </select>
            <button type="submit">Применить</button>
        </form>
    </div>
    <div class="edit">
        <h1>Редактирование плитки</h1>
        <form th:action="@{'/library/game/' + ${game.id} + '/edit'}" method="post">
            <input type="hidden" id="directoryPath" name="directoryPath" th:value="${game.directoryPath}">

            <label for="title">Название игры</label>
            <input type="text" id="title" name="name" th:value="${game.name}">
            <label for="year">Год выпуска</label>
            <input type="text" id="year" name="releaseDate" th:value="${game.releaseDate}">
            <label for="platform">Платформа</label>
            <select id="platform" name="platform">
                <option th:each="platform : ${platforms}" th:value="${platform}" th:text="${platform.toUpperCase()}"></option>
            </select>
            <label for="poster">Постер игры</label>
            <input type="file" id="poster" name="poster" accept="image/*" onchange="previewImage(this)">
            <div id="imagePreview"></div>
            <input type="hidden" id="logo" name="logo" th:value="${game.logo}">
            <script>
                var logoInput = document.getElementById("logo");

                // Проверяем, есть ли значение в поле logo при загрузке формы
                if (logoInput.value) {
                    var imagePreview = document.getElementById("imagePreview");
                    var imgElement = document.createElement("img");
                    imgElement.src = logoInput.value;

                    var removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.innerText = "Удалить";
                    removeButton.onclick = function () {
                        imagePreview.innerHTML = "";
                        logoInput.value = "";
                    };

                    imagePreview.appendChild(imgElement);
                    imagePreview.appendChild(removeButton);
                }
            </script>
            <label for="description">Описание игры</label>
            <textarea id="description" name="description" th:value="${game.description}"></textarea>
            <label for="genre">Жанр</label>
            <select id="genre" name="genre">
                <option value="">Выберите жанр</option>
                <option th:each="genre : ${genres}"
                        th:value="${genre}"
                        th:text="${genre}"></option>
            </select>
            <button type="button" onclick="addGenre()">Добавить</button>
            <div id="genreList">
                <div th:each="genre : ${game.genres}">
                    <span th:text="${genre}"></span>
                    <button type="button" onclick="removeGenre(this)">Удалить</button>
                    <input type="hidden" th:name="genres" th:value="${genre}">
                </div>
            </div>
            <label for="screenshotsUpl">Скриншоты игры</label>
            <input type="file" id="screenshotsUpl" name="screenshotsUpl" accept="image/*" multiple onchange="previewScreenshots(this)">
            <div id="screenshotsList">
                <div th:each="screenshot : ${game.screenshots}" class="screenshot-item">
                    <img th:src="${screenshot}" alt="screenshot">
                    <button type="button" onclick="removeScreenshot(this)">Удалить</button>
                    <input type="hidden" name="screenshots" th:value="${screenshot}">
                </div>
            </div>
            <label for="video">Видео игры</label>
            <input type="url" id="video" name="trailerUrl" th:value="${game.trailerUrl}">
            <label for="instructions">Инструкция по установке игры</label>
            <textarea id="instructions" name="instruction" th:value="${game.instruction}">!</textarea>
            <button type="submit">Сохранить</button>
        </form>
        <a href="#" onclick="goBack()">Отмена</a>
    </div>
</div>
</body>
</html>